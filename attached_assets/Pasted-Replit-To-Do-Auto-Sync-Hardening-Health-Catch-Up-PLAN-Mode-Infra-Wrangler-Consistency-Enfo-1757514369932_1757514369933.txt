Replit To-Do — Auto-Sync Hardening + Health + Catch-Up

PLAN
Mode: Infra Wrangler + Consistency Enforcer
Goal: Make DoorLoop→ECC sync run continuously with self-healing, visible health, and zero drift. Also provide a one-click manual catch-up.

Files to touch

server/lib/sync/auto.ts

server/lib/integrationState.ts

server/routes/syncHealth.ts (new)

server/routes/adminSync.ts (add “reset lock” + “quick run” helpers)

server/index.ts (wire routes)

src/features/admin/pages/AdminSyncPage.tsx (health widget)

Env (confirm/add)

AUTO_SYNC_ENABLED=true
AUTO_SYNC_INTERVAL_MINUTES=10
AUTO_SYNC_FULL_AT_HOUR_UTC=5
SYNC_ENTITIES=owners,properties,units,leases,tenants
DOORLOOP_API_KEY=********
ADMIN_SYNC_TOKEN=********

# NEW (add these)
AUTO_SYNC_LOCK_TTL_MINUTES=20
AUTO_SYNC_HARD_DEADLINE_MINUTES=30

PATCH 1 — Self-healing scheduler + strict locks

Change server/lib/sync/auto.ts to:

Acquire a DB lock with TTL (AUTO_SYNC_LOCK_TTL_MINUTES); if a crash leaves it set, it expires automatically.

Track last_run_at, last_success_at, next_run_at in integration_state key AUTO_SYNC_STATUS.

If last_success_at is older than AUTO_SYNC_HARD_DEADLINE_MINUTES, force a run (“catch-up”).

Always schedule the optional nightly full at AUTO_SYNC_FULL_AT_HOUR_UTC.

Emit audit events: AUTO_SYNC_TICK, AUTO_SYNC_STARTED, AUTO_SYNC_FINISHED, AUTO_SYNC_ERROR.

What to paste (Replit can apply diff):

Open server/lib/sync/auto.ts and replace current scheduler with a version that:
- Reads envs above (with sane defaults).
- Uses integration_state upserts for:
  AUTO_SYNC_LOCK { locked:boolean, holder:string, expires_at }
  AUTO_SYNC_STATUS { last_run_at, last_success_at, next_run_at, mode }
- On interval tick:
   1) If DOORLOOP_API_KEY missing → log & skip (status still updates).
   2) If lock expired OR free → acquire; else if expired → steal.
   3) Decide mode = "incremental" unless it’s within ±10m of nightly full → "full".
   4) Run orchestrator (server/lib/sync/index.ts) for SYNC_ENTITIES.
   5) Update last_success_at on success; release lock; compute next_run_at.
- Wrap runs in try/catch; write audit_events with labels "AUTO_SYNC".

PATCH 2 — Health endpoint + Admin reset

Add server/routes/syncHealth.ts:

GET /api/health/sync → returns { enabled, intervalMinutes, lock, status, entities, nightlyFullHourUtc }.

POST /api/admin/sync/reset-lock (Bearer ADMIN_SYNC_TOKEN) → clears AUTO_SYNC_LOCK (safe reset).

POST /api/admin/sync/quick-run (Bearer token) → fire-and-forget incremental for owners,properties.

What to paste:

Create server/routes/syncHealth.ts with the endpoints above.
Update server/index.ts to app.use() this router.
Extend server/routes/adminSync.ts to include POST /api/admin/sync/reset-lock and /api/admin/sync/quick-run.

PATCH 3 — Admin UI: live status widget

Update src/features/admin/pages/AdminSyncPage.tsx to:

Call /api/health/sync every 15s.

Show:

Enabled ✔ / ✖

Interval (min)

Next run (relative)

Last run / last success (relative, color by freshness)

Lock holder + TTL remaining

Entities list

Nightly full time (UTC)

Buttons (role-gated):

Quick Run (owners+properties)

Reset Lock

Run Full Now

QUICK CATCH-UP (safe now, one click)

If you need the new owner right now, run an incremental for owners+properties:

POST /api/admin/sync
Authorization: Bearer {ADMIN_SYNC_TOKEN}
Content-Type: application/json

{ "mode": "incremental", "entities": ["owners","properties"] }


Or after PATCH 2, use:

POST /api/admin/sync/quick-run
Authorization: Bearer {ADMIN_SYNC_TOKEN}

VERIFY (copy/paste checklist)

Health endpoint

GET /api/health/sync
# Expect enabled:true, reasonable next_run_at, last_success_at recent.


Lock sanity

In /api/health/sync, ensure lock.expires_at is within LOCK_TTL minutes of now.

Run Reset Lock and confirm next tick acquires a fresh lock.

Audit trail

GET /api/audit/recent?limit=20
# Expect AUTO_SYNC_* events with labels for ADMIN_SYNC or AUTO_SYNC.


Data landed

GET /api/entities/owners?query=<name or email>
GET /api/entities/properties?owner_id=<newOwnerId>


Nightly full scheduled

Check nightlyFullHourUtc in health.

Temporarily set AUTO_SYNC_FULL_AT_HOUR_UTC to current UTC hour, restart, confirm “full” run triggers.