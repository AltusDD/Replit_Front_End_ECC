Replit A — Get the Run button working (npm, Node 20)

Operating Mode: Infra Wrangler (no src changes; infra only)

1) Back up & write clean configs
set -euxo pipefail

# Backups
cp -f replit.nix replit.nix.bak 2>/dev/null || true
cp -f .replit .replit.bak 2>/dev/null || true
cp -f package.json package.json.bak 2>/dev/null || true

# Use the hyphenated Node attr that includes npm on PATH
cat > replit.nix <<'NIX'
{ pkgs }: {
  deps = [
    pkgs.nodejs-20_x
  ];
}
NIX

# Ensure Run uses npm; also tell Replit to install with npm
cat > .replit <<'INI'
run = "npm run dev"
hidden = [".cache", ".vite", "dist", "node_modules"]

[packager]
install = "npm ci || npm i"
INI

# (Optional) Keep scripts minimal & npm-friendly; do NOT touch any other fields
# Only update if these differ
node - <<'NODE'
const fs = require('fs');
const p = JSON.parse(fs.readFileSync('package.json','utf8'));
p.scripts = Object.assign({
  dev: "vite --host --port 5000",
  build: "vite build",
  preview: "vite preview --host 0.0.0.0 --port 5000"
}, p.scripts || {});
fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
console.log("package.json scripts verified/updated.");
NODE

2) Trigger a clean env & start

Changing replit.nix will prompt Replit to Rebuild environment. If a banner appears, click Rebuild first. Then run the following:

# Kill any stray Vite
pkill -f vite || true

# Sanity: prefer npm; avoid mixed lockfiles
rm -f pnpm-lock.yaml yarn.lock || true

# Confirm npm exists (it should with nodejs-20_x)
node -v
npm -v

# Install deps if node_modules is missing
[ -d node_modules ] || npm ci || npm i

# Start the dev server (port 5000)
npm run dev

3) Verification checklist

Shell prints versions for both node -v and npm -v (no “command not found”).

Console shows Vite listening on http://0.0.0.0:5000/.

The Run button now works (uses .replit → npm run dev).

No changes were made to src/** — only infra files were touched.

4) Rollback (if needed)
[ -f replit.nix.bak ] && mv -f replit.nix.bak replit.nix
[ -f .replit.bak ] && mv -f .replit.bak .replit
[ -f package.json.bak ] && mv -f package.json.bak package.json


If the Run button still doesn’t light after this, share the last ~30 lines of the Shell output (especially from node -v, npm -v, and npm run dev) and I’ll zero in on the next tweak.